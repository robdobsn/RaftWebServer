/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// RaftWebServer
//
// Rob Dobson 2020-2023
//
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#include <Logger.h>
#include "RaftWebServer.h"
#include <stdint.h>
#include <string.h>

static const char *MODULE_PREFIX = "RaftWebServer";

#define INFO_WEB_SERVER_SETUP

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Constructor
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

RaftWebServer::RaftWebServer()
{
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Setup Web
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void RaftWebServer::setup(RaftWebServerSettings& settings)
{
	// Settings
    _webServerSettings = settings;
    
#ifdef INFO_WEB_SERVER_SETUP
    LOG_I(MODULE_PREFIX, "setup port %d numConnSlots %d wsEn %d enableFileServer %d", 
            settings._serverTCPPort, settings._numConnSlots, 
            settings._enableWebSockets, settings._enableFileServer);
#endif

	// Setup connection manager
	_connManager.setup(_webServerSettings);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Service
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void RaftWebServer::service()
{
    // Service connection manager
    _connManager.service();
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Add handler
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

bool RaftWebServer::addHandler(RaftWebHandler* pHandler)
{
    return _connManager.addHandler(pHandler);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Add response
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void RaftWebServer::addResponseHeader(RdJson::NameValuePair headerInfo)
{
    _connManager.addResponseHeader(headerInfo);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Send to all server-side events
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void RaftWebServer::serverSideEventsSendMsg(const char* eventContent, const char* eventGroup)
{
	_connManager.serverSideEventsSendMsg(eventContent, eventGroup);
}
